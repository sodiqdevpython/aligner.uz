{% load static %}
<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>O'zbek-Ingliz Aligner — GPT bilan moslashtirish</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />

    <style>
      body {
        background-color: #f9f9f9;
        font-family: Arial, sans-serif;
      }

      .container {
        max-width: 950px;
        margin: 40px auto;
        background: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      textarea {
        height: 150px;
      }

      .match {
        background-color: #d4edda !important;
      }

      .nomatch {
        background-color: #f8d7da !important;
      }

      .loading {
        text-align: center;
        font-size: 18px;
        padding: 10px;
      }
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  </head>

  <body>
    <div class="container">
      <h2 class="text-center mb-3">GPT asosidagi O'zbek-Ingliz Aligner</h2>
      <p class="text-center text-muted">
        Gap yoki abzast bo‘yicha moslikni tekshirib beradi
      </p>

      <!-- English -->
      <label class="form-label fw-bold">Inglizcha fayl:</label>
      <input
        type="file"
        class="form-control"
        id="englishFileInput"
        accept=".txt,.docx"
        onchange="loadFile('englishFileInput','englishText')"
      />
      <textarea
        id="englishText"
        class="form-control mt-2"
        placeholder="Inglizcha matn..."
      ></textarea>

      <!-- Uzbek -->
      <label class="form-label fw-bold mt-3">O'zbekcha fayl:</label>
      <input
        type="file"
        class="form-control"
        id="uzbekFileInput"
        accept=".txt,.docx"
        onchange="loadFile('uzbekFileInput','uzbekText')"
      />
      <textarea
        id="uzbekText"
        class="form-control mt-2"
        placeholder="O'zbekcha matn..."
      ></textarea>

      <!-- Mode -->
      <label class="form-label fw-bold mt-3">Moslashtirish turi:</label>
      <select id="alignmentType" class="form-select">
        <option value="sentence">Gap bo'yicha</option>
        <option value="paragraph">Abzast bo'yicha</option>
      </select>

      <button id="alignButton" class="btn btn-success btn-lg mt-3">
        Moslashtirish
      </button>

      <h3 class="text-center mt-4">Natijalar</h3>
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th width="50%">Ingliz</th>
            <th width="50%">O'zbek</th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </div>

    <script>
      /* ===== File loader ===== */
      function loadFile(fileInputId, outputId) {
        const file = document.getElementById(fileInputId).files[0]
        const reader = new FileReader()
        const output = document.getElementById(outputId)

        if (!file) return

        if (file.name.endsWith('.txt')) {
          reader.onload = (e) => (output.value = e.target.result)
          reader.readAsText(file)
        } else if (file.name.endsWith('.docx')) {
          reader.onload = (e) =>
            mammoth
              .extractRawText({ arrayBuffer: e.target.result })
              .then((result) => (output.value = result.value))
          reader.readAsArrayBuffer(file)
        }
      }

      /* ===== Sentence splitter ===== */
      function splitSentences(text) {
        return text.split(/(?<=\.|\!|\?)\s+/).filter((t) => t.trim().length > 0)
      }

      function splitParagraphs(text) {
        return text.split(/\n\s*\n/).filter((t) => t.trim().length > 0)
      }

      /* ===== GPT Proxy Call ===== */
      function askGPT(english, uzbek) {
        const prompt = `
You are a bilingual Uzbek-English alignment expert. Compare the following:

English: "${english}"
Uzbek: "${uzbek}"

Your task:
1. Analyze semantic similarity.
2. Determine if they match in meaning.
3. Rate similarity 0–100.
4. If mismatch, explain why.

Respond ONLY in valid JSON:

{
  "english": "<clean English>",
  "uzbek": "<clean Uzbek>",
  "is_match": true/false,
  "similarity_score": 0-100,
  "comment": "<short explanation>"
}
        `

        const formData = new FormData()
        formData.append('english', english)
        formData.append('uzbek', uzbek)
        formData.append('prompt', prompt)

        return fetch('/gpt-align/', {
          method: 'POST',
          body: formData,
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              console.error(data.error)
              alert('GPT xato qaytardi: ' + data.error)
              return null
            }
            return JSON.parse(data.result)
          })
      }

      /* ===== Main function ===== */
      $('#alignButton').click(async function () {
        const englishText = $('#englishText').val()
        const uzbekText = $('#uzbekText').val()
        const type = $('#alignmentType').val()

        if (!englishText || !uzbekText) {
          alert('Matnlar bo‘sh bo‘lmasligi kerak!')
          return
        }

        let englishParts =
          type === 'sentence'
            ? splitSentences(englishText)
            : splitParagraphs(englishText)
        let uzbekParts =
          type === 'sentence'
            ? splitSentences(uzbekText)
            : splitParagraphs(uzbekText)

        if (englishParts.length !== uzbekParts.length) {
          alert("Inglizcha va O'zbekcha segmentlar soni teng emas!")
          return
        }

        $('#resultsTable').empty()
        $('#loading').removeClass('d-none')

        for (let i = 0; i < englishParts.length; i++) {
          let result = await askGPT(englishParts[i], uzbekParts[i])

          let cssClass = result.is_match ? 'match' : 'nomatch'

          $('#resultsTable').append(`
                <tr class="${cssClass}">
                    <td>
                        <b>${result.english}</b>
                        <br><small>Score: ${result.similarity_score}%</small>
                    </td>
                    <td>
                        ${result.uzbek}
                        <br><small>${result.comment}</small>
                    </td>
                </tr>
            `)
        }

        $('#loading').addClass('d-none')
      })
    </script>
  </body>
</html>
