{% load static %}
<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="google-site-verification"
      content="9O8PfyVsuurYJEE3pkewVAwI_F1kXWDqcR5-Vl7AswA"
    />
    <link rel="icon" href="{% static 'images/favicon.ico' %}" />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-EJNWG40NH5"
    ></script>
    <script src="{% static 'gtag.js' %}"></script>
    <script src="{% static 'index.js' %}"></script>
    <title>O'zbek-Ingliz "Aligner" Dasturi</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />

    <style>
      body {
        background-color: #f9f9f9;
        font-family: Arial, sans-serif;
      }

      .container {
        max-width: 950px;
        margin: 40px auto;
        background: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      textarea {
        height: 150px;
      }

      .match {
        background-color: #d4edda !important;
      }

      .nomatch {
        background-color: #f8d7da !important;
      }

      #loading {
        display: none;
        font-size: 18px;
        text-align: center;
        margin-top: 20px;
      }

      .ai-loader {
        display: none;
        text-align: center;
        margin-top: 20px;
        padding: 20px;
      }

      .pulse {
        width: 30px;
        height: 30px;
        margin: 0 auto 10px auto;
        background: #4caf50;
        border-radius: 50%;
        animation: pulseAnim 1.5s infinite ease-in-out;
      }

      @keyframes pulseAnim {
        0% {
          transform: scale(0.9);
          opacity: 0.7;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
        100% {
          transform: scale(0.9);
          opacity: 0.7;
        }
      }

      .loading-text {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .dots::after {
        content: '';
        animation: dotsAnim 1.5s infinite;
      }

      @keyframes dotsAnim {
        0% {
          content: '';
        }
        33% {
          content: '.';
        }
        66% {
          content: '..';
        }
        100% {
          content: '...';
        }
      }
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  </head>

  <body>
    <div class="container">
      <h2 class="text-center mb-3">Ingliz-O'zbek "Aligner" dasturi</h2>

      <!-- English -->
      <label class="form-label fw-bold">Inglizcha matn:</label>
      <textarea
        id="englishText"
        class="form-control mt-2"
        placeholder="Inglizcha matn..."
        maxlength="1500"
      ></textarea>

      <!-- Uzbek -->
      <label class="form-label fw-bold mt-3">O'zbekcha matn:</label>
      <textarea
        id="uzbekText"
        class="form-control mt-2"
        placeholder="O'zbekcha matn..."
        maxlength="1500"
      ></textarea>

      <!-- Mode -->
      <label class="form-label fw-bold mt-3">Moslashtirish turi:</label>
      <select id="alignmentType" class="form-select">
        <option value="sentence">Gap bo'yicha</option>
        <option value="paragraph">Abzast bo'yicha</option>
      </select>

      <button id="alignButton" class="btn btn-success btn-lg mt-3 w-100">
        Moslashtirish
      </button>

      <div id="loading" class="ai-loader">
        <div class="pulse"></div>
        <div class="loading-text">
          Moslik aniqlanmoqda<span class="dots"></span>
        </div>
      </div>

      <h3 class="text-center mt-4">Natijalar</h3>
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th width="50%">Ingliz</th>
            <th width="50%">O'zbek</th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </div>

    <script>
      function ask(english, uzbek, type) {
        const formData = new FormData()
        formData.append('english', english)
        formData.append('uzbek', uzbek)
        formData.append('type', type)

        return fetch('/gpt-align/', {
          method: 'POST',
          body: formData,
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              alert('xato: ' + data.error)
              return null
            }
            return JSON.parse(data.result)
          })
      }

      $('#alignButton').click(async function () {
        const englishText = $('#englishText').val()
        const uzbekText = $('#uzbekText').val()
        const type = $('#alignmentType').val()

        if (!englishText || !uzbekText) {
          alert('Matnlar bo‘sh bo‘lmasligi kerak!')
          return
        }

        $('#resultsTable').empty()
        $('#loading').show()

        let results = await ask(englishText, uzbekText, type)

        $('#loading').hide()

        if (!results) return

        results.forEach((row) => {
          let cssClass = row.is_match ? 'match' : 'nomatch'

          $('#resultsTable').append(`
            <tr class="${cssClass}">
                <td>
                    <b>${row.english}</b>
                    <br><small>Score: ${row.similarity_score}%</small>
                </td>
                <td>${row.uzbek}</td>
            </tr>
        `)
        })
      })
    </script>
  </body>
</html>
